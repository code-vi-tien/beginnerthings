generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String              @id @default(uuid())
  email                 String              @unique
  password              String
  username              String
  role                  Role                @default(CUSTOMER)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  cart                  Cart?            
  orders                Order[]
  payments              Payment[]
}

model Cart {
  id                    String              @id @default(uuid())
  user                  User?               @relation(fields: [userId], references: [id])
  userId                String              @unique
  status                CartStatus          @default(ACTIVE)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  lastActiveAt          DateTime            @default(now())
 
  cartItems             CartItem[]
}

model CartItem {
  id                    String              @id @default(uuid())
  cart                  Cart?               @relation(fields: [cartId], references: [id])
  cartId                String?
  product               Product?            @relation(fields: [productId], references: [id])
  productId             String
  @@unique([cartId, productId, variant])
  variant               String?
  quantity              Int                 @default(1)
  priceSnapshot         Float     
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
}

model Product {
  id                    String              @id @default(uuid())
  name                  String              
  price                 Float
  stock                 Int
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  cartItems             CartItem[]
}

model Order {
  id                    String              @id @default(uuid())
  user                  User?               @relation(fields: [userId], references: [id])
  userId                String?
  payment               Payment?            @relation(fields: [paymentId], references: [id])
  paymentId             String?             @unique
  status                OrderStatus         @default(PENDING)
  subtotal              Float
  tax                   Float       
  total                 Float 
  cartSnapshot          Json
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
}

model Payment {
  id                    String              @id @default(uuid())
  user                  User?               @relation(fields: [userId], references: [id])
  userId                String?
  order                 Order?                      
  provider              PaymentProvider
  providerSessionId     String?             
  status                PaymentStatus       @default(INITIATED)
  amount                Float    
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
}

enum Role {
  CUSTOMER
  EMPLOYEE
  ADMIN
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CHECKED_OUT
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  CANCELED
}

enum PaymentProvider {
  VNPAY
  STRIPE
  INTERNAL
}

enum PaymentStatus {
  INITIATED
  SUCCEEDED
  FAILED
}

model DebugTest {
  id String   @id@default(uuid())
}